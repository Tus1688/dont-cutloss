//
//  ChartDataView.swift
//  dont-cutloss
//
//  Created by user on 04/05/24.
//

import SwiftUI
import Charts

struct ChartDataView: View {
    public let data: ChartDataResult
    
    private var chartData: [visualizeData] {
        let prevTimestamp = data.timestamp ?? []
        let cleanTimestamp = prevTimestamp.compactMap { $0 }
        let prevClose = data.indicators?.quote?[0].close ?? []
        let cleanClose = prevClose.compactMap { $0 }
        
        var chartData: [visualizeData] = []
        for i in 0..<cleanClose.count {
            chartData.append(visualizeData(x: String(cleanTimestamp[i]), y: cleanClose[i]))
        }
        return chartData
    }

    private var low: Decimal {
        // iterate the chartData to find the lowest value
        chartData.map { $0.y }.min() ?? 0
    }
    
    private var high: Decimal {
        // iterate the chartData to find the highest value
        chartData.map { $0.y }.max() ?? 0
    }
    
    private var bullish: Bool {
        chartData.last?.y ?? 0 > data.meta?.previousClose ?? 0
    }
    
    var body: some View {
        VStack {
            Chart(chartData, id: \.x) { value in
                LineMark(
                    x: .value("Period", value.x),
                    y: .value("Close", value.y)
                )
                .foregroundStyle(bullish ? .green : .red)
            }
            .chartYScale(domain: low...high)
            .chartYAxis {
                AxisMarks(position: .trailing) { _ in
                    AxisValueLabel()
                }
            }
            .chartXAxis(.hidden)
            .frame(height: 150)
        }
    }
}

private struct visualizeData {
    let x: String
    let y: Decimal
}

#Preview {
    struct previewChartDataView: View {
        let data: ChartDataResult = ChartDataResult(
            meta: ChartDataMeta(exchangeTimezoneName: "America/New_York", regularMarketDayHigh: 186, regularMarketDayLow: 182),
            timestamp: [1714743000,1714743060,1714743120,1714743180,1714743240,1714743300,1714743360,1714743420,1714743480,1714743540,1714743600,1714743660,1714743720,1714743780,1714743840,1714743900,1714743960,1714744020,1714744080,1714744140,1714744200,1714744260,1714744320,1714744380,1714744440,1714744500,1714744560,1714744620,1714744680,1714744740,1714744800,1714744860,1714744920,1714744980,1714745040,1714745100,1714745160,1714745220,1714745280,1714745340,1714745400,1714745460,1714745520,1714745580,1714745640,1714745700,1714745760,1714745820,1714745880,1714745940,1714746000,1714746060,1714746120,1714746180,1714746240,1714746300,1714746360,1714746420,1714746480,1714746540,1714746600,1714746660,1714746720,1714746780,1714746840,1714746900,1714746960,1714747020,1714747080,1714747140,1714747200,1714747260,1714747320,1714747380,1714747440,1714747500,1714747560,1714747620,1714747680,1714747740,1714747800,1714747860,1714747920,1714747980,1714748040,1714748100,1714748160,1714748220,1714748280,1714748340,1714748400,1714748460,1714748520,1714748580,1714748640,1714748700,1714748760,1714748820,1714748880,1714748940,1714749000,1714749060,1714749120,1714749180,1714749240,1714749300,1714749360,1714749420,1714749480,1714749540,1714749600,1714749660,1714749720,1714749780,1714749840,1714749900,1714749960,1714750020,1714750080,1714750140,1714750200,1714750260,1714750320,1714750380,1714750440,1714750500,1714750560,1714750620,1714750680,1714750740,1714750800,1714750860,1714750920,1714750980,1714751040,1714751100,1714751160,1714751220,1714751280,1714751340,1714751400,1714751460,1714751520,1714751580,1714751640,1714751700,1714751760,1714751820,1714751880,1714751940,1714752000,1714752060,1714752120,1714752180,1714752240,1714752300,1714752360,1714752420,1714752480,1714752540,1714752600,1714752660,1714752720,1714752780,1714752840,1714752900,1714752960,1714753020,1714753080,1714753140,1714753200,1714753260,1714753320,1714753380,1714753440,1714753500,1714753560,1714753620,1714753680,1714753740,1714753800,1714753860,1714753920,1714753980,1714754040,1714754100,1714754160,1714754220,1714754280,1714754340,1714754400,1714754460,1714754520,1714754580,1714754640,1714754700,1714754760,1714754820,1714754880,1714754940,1714755000,1714755060,1714755120,1714755180,1714755240,1714755300,1714755360,1714755420,1714755480,1714755540,1714755600,1714755660,1714755720,1714755780,1714755840,1714755900,1714755960,1714756020,1714756080,1714756140,1714756200,1714756260,1714756320,1714756380,1714756440,1714756500,1714756560,1714756620,1714756680,1714756740,1714756800,1714756860,1714756920,1714756980,1714757040,1714757100,1714757160,1714757220,1714757280,1714757340,1714757400,1714757460,1714757520,1714757580,1714757640,1714757700,1714757760,1714757820,1714757880,1714757940,1714758000,1714758060,1714758120,1714758180,1714758240,1714758300,1714758360,1714758420,1714758480,1714758540,1714758600,1714758660,1714758720,1714758780,1714758840,1714758900,1714758960,1714759020,1714759080,1714759140,1714759200,1714759260,1714759320,1714759380,1714759440,1714759500,1714759560,1714759620,1714759680,1714759740,1714759800,1714759860,1714759920,1714759980,1714760040,1714760100,1714760160,1714760220,1714760280,1714760340,1714760400,1714760460,1714760520,1714760580,1714760640,1714760700,1714760760,1714760820,1714760880,1714760940,1714761000,1714761060,1714761120,1714761180,1714761240,1714761300,1714761360,1714761420,1714761480,1714761540,1714761600,1714761660,1714761720,1714761780,1714761840,1714761900,1714761960,1714762020,1714762080,1714762140,1714762200,1714762260,1714762320,1714762380,1714762440,1714762500,1714762560,1714762620,1714762680,1714762740,1714762800,1714762860,1714762920,1714762980,1714763040,1714763100,1714763160,1714763220,1714763280,1714763340,1714763400,1714763460,1714763520,1714763580,1714763640,1714763700,1714763760,1714763820,1714763880,1714763940,1714764000,1714764060,1714764120,1714764180,1714764240,1714764300,1714764360,1714764420,1714764480,1714764540,1714764600,1714764660,1714764720,1714764780,1714764840,1714764900,1714764960,1714765020,1714765080,1714765140,1714765200,1714765260,1714765320,1714765380,1714765440,1714765500,1714765560,1714765620,1714765680,1714765740,1714765800,1714765860,1714765920,1714765980,1714766040,1714766100,1714766160,1714766220,1714766280,1714766340,1714766400],
            indicators: ChartDataIndicators(
                quote: [
                    ChartDataQuote(
                        close: [185.8699951171875,185.48260498046875,185.476806640625,185.5399932861328,185.01010131835938,185.08999633789062,184.46499633789062,184.59500122070312,184.77000427246094,184.6699981689453,184.625,184.07000732421875,183.97000122070312,183.88999938964844,183.7303009033203,184.05499267578125,184.19000244140625,184.2449951171875,183.93499755859375,184.19000244140625,184.38999938964844,184.40499877929688,184.87010192871094,184.8300018310547,184.83309936523438,184.66000366210938,184.69430541992188,184.5,184.22500610351562,184.11500549316406,183.9398956298828,183.36000061035156,183.22500610351562,182.88499450683594,183.48500061035156,183.64999389648438,183.66400146484375,183.72000122070312,183.55470275878906,183.6199951171875,183.72000122070312,183.58999633789062,183.7899932861328,183.89999389648438,184.05999755859375,183.86000061035156,183.9488983154297,184.00979614257812,183.8052978515625,183.6300048828125,183.62010192871094,184.24000549316406,184.16029357910156,184.1999969482422,184.32000732421875,184.11920166015625,183.93499755859375,183.9199981689453,183.95779418945312,nil,nil,nil,nil,nil,nil,nil,nil,184.04750061035156,184.11000061035156,184.4250030517578,184.5742950439453,184.65499877929688,184.5666046142578,184.75999450683594,184.875,184.6905975341797,184.7449951171875,184.82859802246094,184.7899932861328,184.80999755859375,184.6300048828125,184.7899932861328,184.69500732421875,184.6999969482422,184.72000122070312,184.86000061035156,184.8249969482422,184.6280975341797,184.67999267578125,184.77999877929688,184.9149932861328,184.9499969482422,184.9149932861328,184.89999389648438,184.75,184.5334930419922,184.57000732421875,184.60009765625,184.63389587402344,184.3498992919922,184.17999267578125,184.02000427246094,184.0500030517578,184.03500366210938,184.1300048828125,184.235107421875,184.4600067138672,184.6125030517578,184.5,184.42120361328125,184.5500030517578,nil,184.6699981689453,184.32000732421875,183.9600067138672,184.125,184.25,184.44000244140625,184.72000122070312,184.64999389648438,184.66000366210938,184.63499450683594,184.77000427246094,184.75,184.8000030517578,184.73500061035156,184.83999633789062,184.77999877929688,184.625,184.68980407714844,184.80499267578125,184.8300018310547,184.8419952392578,184.85980224609375,184.6405029296875,184.6300048828125,184.70989990234375,184.5449981689453,184.60000610351562,184.60400390625,184.60499572753906,184.52000427246094,184.6199951171875,184.75,184.72999572753906,184.64999389648438,184.5800018310547,184.55450439453125,184.6011962890625,184.59500122070312,184.72500610351562,184.71499633789062,184.75,184.6699981689453,184.69500732421875,184.69000244140625,184.65499877929688,184.64120483398438,184.5449981689453,184.4949951171875,184.52499389648438,184.6177978515625,184.4550018310547,184.16990661621094,184.18499755859375,184.4199981689453,184.27499389648438,184.2449951171875,184.22500610351562,184.2397003173828,184.2550048828125,184.26499938964844,184.40989685058594,184.44000244140625,184.32000732421875,184.3101043701172,184.4176025390625,184.44000244140625,184.42999267578125,184.36000061035156,184.3800048828125,184.45640563964844,184.4499969482422,184.57000732421875,184.59500122070312,184.59500122070312,184.55740356445312,184.52499389648438,184.5850067138672,184.63999938964844,184.610107421875,184.5050048828125,184.63999938964844,184.6999969482422,184.7449951171875,184.72000122070312,184.9149932861328,184.88999938964844,184.91000366210938,184.9149932861328,184.88499450683594,184.84500122070312,184.81500244140625,184.875,184.88999938964844,184.8350067138672,184.60910034179688,184.5970001220703,184.73500061035156,184.7550048828125,184.74000549316406,184.7949981689453,184.6199951171875,184.7790985107422,184.875,184.9188995361328,184.90499877929688,184.88499450683594,184.93850708007812,184.8699951171875,184.9149932861328,184.92250061035156,184.92999267578125,184.92999267578125,184.97000122070312,184.88009643554688,184.87289428710938,184.86000061035156,184.85000610351562,184.9550018310547,184.98260498046875,184.97999572753906,184.98500061035156,185.0,185.22500610351562,185.18569946289062,185.30990600585938,185.4199981689453,185.48370361328125,185.360107421875,185.2949981689453,185.2949981689453,185.22000122070312,185.07000732421875,185.26499938964844,185.14320373535156,185.11000061035156,185.05999755859375,185.14500427246094,185.2050018310547,185.28500366210938,185.2100067138672,185.1569061279297,184.8800048828125,184.98789978027344,185.0500030517578,185.0749969482422,185.07000732421875,185.08880615234375,185.02499389648438,185.00999450683594,185.0500030517578,185.0800018310547,185.1699981689453,185.22999572753906,185.14500427246094,185.1300048828125,185.085693359375,185.10499572753906,185.05499267578125,185.17999267578125,185.1300048828125,185.14999389648438,185.38400268554688,185.39500427246094,185.3249969482422,185.39500427246094,185.4951934814453,185.66000366210938,185.60499572753906,185.60000610351562,185.60000610351562,185.61000061035156,185.61990356445312,185.63499450683594,185.7449951171875,185.7449951171875,185.73269653320312,185.7550048828125,185.78500366210938,185.80499267578125,185.83709716796875,185.7113037109375,185.61500549316406,185.68829345703125,185.74000549316406,185.78500366210938,185.80499267578125,185.7899932861328,185.75,185.8350067138672,185.8096923828125,185.8800048828125,185.8249969482422,185.88999938964844,185.86990356445312,185.89500427246094,185.8350067138672,185.94500732421875,185.875,185.7550048828125,185.85499572753906,185.875,185.80999755859375,185.6436004638672,185.66000366210938,185.30999755859375,185.20120239257812,185.19700622558594,185.26890563964844,185.30499267578125,185.47500610351562,185.6199951171875,185.52499389648438,185.55499267578125,185.52499389648438,185.5050048828125,185.5800018310547,185.4499969482422,185.35499572753906,185.22999572753906,185.21249389648438,185.2198944091797,185.14999389648438,185.19500732421875,185.0850067138672,185.05189514160156,184.9499969482422,184.96499633789062,184.97500610351562,185.01499938964844,184.9149932861328,184.86000061035156,184.90499877929688,184.8699951171875,184.89500427246094,184.9949951171875,184.875,184.7550048828125,184.63999938964844,184.31370544433594,184.61000061035156,184.72000122070312,184.7899932861328,184.69000244140625,184.8800048828125,184.9499969482422,184.92999267578125,184.88999938964844,184.9949951171875,184.88999938964844,184.8699951171875,184.92750549316406,184.85000610351562,184.7198944091797,184.67999267578125,184.60000610351562,184.49000549316406,184.57000732421875,184.63999938964844,184.5,184.4550018310547,184.25,184.24000549316406,184.2449951171875,184.21499633789062,184.125,184.05499267578125,184.006103515625,183.9949951171875,184.00799560546875,184.07859802246094,184.06500244140625,183.69500732421875,183.49000549316406,183.2324981689453,183.33009338378906,183.2689971923828,183.1199951171875,183.38999938964844,183.3800048828125]
                    )
                ]
            )
        )
        var body: some View {
            ChartDataView(data: data)
        }
    }
    return previewChartDataView()
}
